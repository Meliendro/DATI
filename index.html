<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parametri Vitali - Web App</title>
 
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f2f4f7;
  margin: 0;
  padding: 10px;
}
.box {
  background: white;
  padding: 15px;
  border-radius: 14px;
  margin-bottom: 15px;
}
h1 { text-align: center; }

input, button { width: 100%; padding: 12px; font-size: 16px; margin-top: 8px; }
button { background: #007aff; color: white; border: none; border-radius: 10px; }
button.secondary { background: #666; }
button.danger { background: #d9534f; }

.tabs { display: flex; overflow-x: auto; margin-bottom: 10px; }
.tab { padding: 10px 16px; margin-right: 6px; background: #ddd; border-radius: 10px; white-space: nowrap; cursor: pointer; }
.tab.active { background: #007aff; color: white; }

table { width: 100%; border-collapse: collapse; font-size: 14px; }
th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
th { background: #f0f0f0; }
.highlight { background: #fff3cd !important; }

.actions { display: flex; gap: 6px; }
.actions button { padding: 6px 8px; font-size: 14px; }
.table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
.hidden { display: none; }
</style>
</head>
<body>

<h1>Parametri Vitali</h1>

<form id="dataForm" class="box">
  <input type="date" id="date" required>
  <input type="time" id="time" required>
  <input type="text" id="slot" readonly>

  <input type="number" id="min" placeholder="Min" required>
  <input type="number" id="max" placeholder="Max" required>
  <input type="number" id="pulse" placeholder="Pulsazioni" required>
  <input type="number" id="sat" placeholder="Saturazione %" required>
  <input type="number" step="0.1" id="temp" placeholder="Temperatura ¬∞C" required>

  <button type="submit">üíæ Salva</button>
</form>

<div class="box">
  <button onclick="exportJSON()">üíæ Esporta dati JSON</button>
  <input type="file" id="importFile" style="margin-top:8px;">
  <button class="secondary" onclick="importJSON()">üìÇ Importa dati JSON</button>
</div>

<div class="tabs" id="monthTabs"></div>
<div id="monthContent"></div>

<script>
let records = JSON.parse(localStorage.getItem("vitali")) || [];
let editingIndex = null;
let highlightIndex = null;
let activeMonth = null;

/* ===== UTIL ===== */
function save() { localStorage.setItem("vitali", JSON.stringify(records)); }
function fasciaOraria(o) { return (o >= "00:01" && o <= "12:00") ? "Mattina" : "Pomeriggio"; }
function setNow() {
  const n = new Date();
  date.value = n.toISOString().substring(0,10);
  time.value = n.toTimeString().substring(0,5);
  slot.value = fasciaOraria(time.value);
}
time.onchange = () => slot.value = fasciaOraria(time.value);

/* ===== FORM ===== */
dataForm.onsubmit = e => {
  e.preventDefault();
  if (editingIndex !== null && !confirm("Vuoi salvare le modifiche a questo record?")) return;

  const d = {
    date: date.value,
    time: time.value,
    slot: fasciaOraria(time.value),
    min: min.value,
    max: max.value,
    pulse: pulse.value,
    sat: sat.value,
    temp: temp.value
  };

  if (editingIndex !== null) {
    records[editingIndex] = d;
    highlightIndex = editingIndex;
    editingIndex = null;
  } else {
    records.push(d);
    highlightIndex = records.length - 1;
  }

  save();
  setNow();
  render();
  e.target.reset();
};

/* ===== RENDER ===== */
function render() {
  const grouped = {};
  records.forEach((r,i)=>{
    const m = r.date.substring(0,7);
    if(!grouped[m]) grouped[m] = [];
    grouped[m].push({...r,index:i});
  });

  const months = Object.keys(grouped).sort();
  if (!activeMonth && months.length) activeMonth = months[months.length-1];

  monthTabs.innerHTML = months.map(m=>`<div class="tab ${m===activeMonth?'active':''}" onclick="selectMonth('${m}')">${m}</div>`).join("");
  renderMonth(grouped[activeMonth] || []);
}

function renderMonth(data) {
  monthContent.innerHTML = `
    <div class="box">
      <div class="table-wrapper">
      <table>
        <tr>
          <th>Data</th><th>Ora</th><th>Min</th><th>Max</th><th>Azioni</th>
        </tr>
        ${data.map(r=>`
        <tr class="${r.index===highlightIndex?'highlight':''}">
          <td>${r.date}</td>
          <td>${r.time}</td>
          <td>${r.min}</td>
          <td>${r.max}</td>
          <td class="actions">
            <button onclick="showDetails(${r.index})">‚ÑπÔ∏è</button>
            <button onclick="editRecord(${r.index})">‚úèÔ∏è</button>
            <button class="danger" onclick="deleteRecord(${r.index})">üóëÔ∏è</button>
          </td>
        </tr>`).join("")}
      </table>
      </div>
    </div>
  `;
}

/* ===== AZIONI ===== */
function selectMonth(m) { activeMonth=m; highlightIndex=null; render(); }
function editRecord(i){
  const r=records[i];
  date.value=r.date; time.value=r.time; slot.value=r.slot;
  min.value=r.min; max.value=r.max; pulse.value=r.pulse;
  sat.value=r.sat; temp.value=r.temp;
  editingIndex=i;
}
function deleteRecord(i){ if(confirm("Cancellare il record?")){ records.splice(i,1); save(); render(); } }
function showDetails(i){
  const r = records[i];
  alert(`üìÖ Data: ${r.date}\n‚è∞ Ora: ${r.time}\nüïí Fascia: ${r.slot}\n‚ù§Ô∏è Pulsazioni: ${r.pulse}\nü©∏ Saturazione: ${r.sat}%\nüå°Ô∏è Temperatura: ${r.temp}¬∞`);
}

/* ===== JSON IMPORT/EXPORT ===== */
function exportJSON(){
  const blob = new Blob([JSON.stringify(records,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "parametri_vitali.json";
  a.click();
}

function importJSON(){
  const file = document.getElementById("importFile").files[0];
  if(!file){ alert("Seleziona un file JSON"); return; }
  const reader = new FileReader();
  reader.onload = e=>{
    try{
      const data = JSON.parse(e.target.result);
      if(Array.isArray(data)){ records=data; save(); render(); alert("Dati importati correttamente"); }
      else alert("File non valido");
    }catch(err){ alert("Errore parsing JSON"); }
  };
  reader.readAsText(file);
}

/* ===== INIZIALIZZAZIONE ===== */
setNow();
render();
</script>

</body>
</html>

